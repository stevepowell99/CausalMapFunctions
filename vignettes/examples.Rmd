---
htitle: "Causal Map Functions Vignette"
author: "Steve Powell"
date: "24/09/2021"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: false
    theme: lumen
---


```{r setup, include=FALSE}
options(dplyr.summarise.inform = FALSE)
library(CausalMapFunctions)
library(knitr)
library(kableExtra)
knitr::opts_chunk$set(echo = TRUE)
source("../R/functions.R")################################



```

## Loading example datasets

(After loading CausalMapFunctions library)


The package ships with some example datasets, at the moment just these:

- example2
- quip_example

which you can also view in Causal Map on the web.

You can load the files like this:

```{r }

example2 <- load_premap("example2") %>% pipe_coerce_mapfile()#### should not be necessary TODO 

example2

example2 %>% summary

```

Visualise them like this:

```{r }
example2 %>% make_interactive_map

```

You can also load up an Excel file:

```{r }
# system.file("extdata", "quip-lorem", package = "CausalMapFunctions") %>% 
#   get_mapfile_from_excel()

```

The file should have the standard Causal Map [format](guide.causalmap.app/core-tables.html): you can see an example by downloading any of the files in Causal Map on the web.


`pipe_coerce_mapfile` will also process a file with no factors and from_label and to_label columns as a named edgelist.


If you filter the factors of a mapfile, e.g. show only factors with labels beginning xyz,

- also the links are filtered (removing links to removed factors)
- the statements are not touched

If you filter the links of a mapfile, e.g. show only links with hashtags containing xyz,

- the factors are not filtered (but using a different command you can remove any factors which no longer have any links)
- the statements are not touched

If you filter the statements of a mapfile, e.g. show only statements with texts containing xyz,

- also the links are filtered (removing links to removed statements)
- the factors are filtered



```{r }
  # ll <- quip_example
  # ee <- example2
  ee <- load_premap("example2")%>% pipe_coerce_mapfile 
  so <- load_premap("stress-opposites")%>% pipe_coerce_mapfile 
  tt <- load_premap("cm1/tearfund-sl")%>% pipe_coerce_mapfile
  ll <- load_premap("quip-coded")%>% pipe_coerce_mapfile
  oo <- load_premap("organisation1coded")%>% pipe_coerce_mapfile
  e3 <- load_premap("example3-path-tracing")%>% pipe_coerce_mapfile
  mm <- load_premap("save-the-children-mozambique-copy")%>% pipe_coerce_mapfile
  hh <- load_premap("hannahcombiningopposites-sp-test")%>% pipe_coerce_mapfile
```

## Basic examples

### Accessing the data 

One column in one table

```{r }  
ll %>%
    pipe_find_factors(value="economic") %>%
    .$factors %>%
    .$label %>% 
  knitr::kable()
```

### Merging two maps 

```{r }  
merge_mapfile(ee,tt %>% pipe_select_factors(top=8)) %>% 
  pipe_color_factors(field="map_id") %>% 
  pipe_color_links(field="map_id",fun="unique") %>% 
  make_interactive_map

```

Note warning if factor labels are shared


```{r }  
load_premap("example2") %>%
  pipe_coerce_mapfile %>% 
  pipe_merge_mapfile("example2") %>% 
  pipe_color_factors(field="map_id") %>% 
  pipe_color_links(field="map_id",fun="unique") %>% 
  make_interactive_map

```

### Editing maps directly

There is no guarantee that the resulting map is still a standard mapfile.

```{r }  
ee$factors$label[1] <- "Label changed"
ee %>% make_interactive_map
```

### Editing maps with pipe_update_mapfile

There is no guarantee that the resulting map is still a standard mapfile.

```{r }  
ee %>% 
  pipe_update_mapfile(factors = ee$factors %>% mutate(label="one")) %>% 
  make_interactive_map
```

Coercing to a standard mapfile:

```{r }  
ee %>% 
  pipe_update_mapfile(factors = ee$factors %>% mutate(label="one")) %>% 
  pipe_coerce_mapfile() %>% 
  make_interactive_map
```


### Interactive and Print maps

```{r }  
  ee %>%
    pipe_label_links("link_id") %>%
    make_interactive_map
  ee %>%
    pipe_label_links("link_id") %>%
    make_print_map()
  ee %>%
    pipe_set_print(grv_layout="circo") %>%
    make_print_map()
```

### Selecting and finding 

factors links and statements

```{r }  
ll %>%
    pipe_select_factors(15) %>%
    make_interactive_map

```


Simple frequency

```{r }  
ll %>%
    pipe_find_links("simple_frequency",value = 50,"greater") %>%
    make_interactive_map

```


```{r }  
ll %>%
    pipe_select_links(5) %>%
    make_interactive_map

```

```{r }  
ll %>%
    pipe_find_statements(field="statement_id",value=5,operator="equals") %>%
    make_interactive_map
```

```{r }  
ll %>%
    pipe_find_factors(value="economic") %>%
    make_interactive_map
```

Case insensitive

```{r }  
ee %>%
    pipe_find_factors(value="business") %>%
    make_interactive_map

```

Should these work?

```{r }  
ee %>%
    pipe_find_factors(value="business|property") %>%
    make_interactive_map

```

```{r }  
ee %>%
    pipe_find_factors(value="business OR property") %>%
    make_interactive_map

```

### notcontains

```{r }  
ee %>%
    pipe_find_factors(value="sea",operator="notcontains") %>%
    make_interactive_map

```

```{r }  
ee %>%
    pipe_find_factors(value=c("sea", "High"),operator="notcontains") %>%
    make_interactive_map

```
```{r }  
ee %>% pipe_find_statements(value="1",operator="notcontains",field="statement_id")%>%
    make_interactive_map

```

```{r }  
ee %>% pipe_find_statements(value="1",operator="notcontains",field="statement_id")%>%
    make_interactive_map

```

### notequals

```{r }  
ee %>% pipe_find_statements(value="1",operator="notequals",field="statement_id")%>%
    make_interactive_map

```


```{r }  
ee %>%
    pipe_find_factors(value=c("Coastal erosion"),operator="notequals") %>%
    make_interactive_map

```




Does work:

```{r }  
ee %>%
    pipe_find_factors(value=c("business", "property")) %>%
    make_interactive_map

```


Order matters

```{r }  
ll %>%
    pipe_find_factors(value="economic") %>%
    pipe_select_factors(5) %>%
    make_interactive_map

```

No result

```{r }  
ll %>%
    pipe_find_factors(value="asdfasdfasdf") %>%
    make_interactive_map
```



```{r }  
ll %>%
    pipe_find_links(field="from_label",value="economic",operator="contains") %>%
    make_interactive_map
```

### Numerical comparison

```{r }  
ll %>%
    pipe_find_statements(field="statement_id",value=20,operator="less") %>%
    make_interactive_map
```

No result

```{r }  
ll %>%
    pipe_find_statements(field="statement_id",value=20000000,operator="greater") %>%
    make_interactive_map
```

### Highlight only

```{r }  
e3  %>% 
  pipe_find_factors(value="Damage",highlight_only=T) %>% pipe_color_factors(field="found") %>% 
  make_interactive_map()

```

Note this doe sn'twork in the app:

```{r }  
e3  %>% 
  pipe_find_links(field="from_label",value="Damage",highlight_only=T) %>%     
  pipe_color_links(field="found",fun="literal") %>% 
  make_interactive_map()

```
## Conditional formatting

```{r }  
ll %>%
    pipe_select_factors(5) %>%
    pipe_scale_factors(field="frequency") %>%
    make_interactive_map
```

```{r }
ll %>%
    pipe_select_factors(5) %>%
    pipe_color_factors(field="frequency") %>%
    pipe_color_borders(field="betweenness") %>%
    pipe_wrap_factors(5) %>%
    make_interactive_map

```

```{r }
ll %>%
    pipe_select_factors(5) %>%
    pipe_color_links(value="count: link_id") %>%
    pipe_wrap_factors(5) %>%
    make_interactive_map

```

```{r }  

ee %>%
    pipe_label_links("from_label",fun = "unique") %>%
    pipe_wrap_links(6) %>%
    make_interactive_map

```

```{r }  

ee %>%
    pipe_label_links(value="unique: from_label") %>%
    pipe_wrap_links(6) %>%
    make_interactive_map

```

```{r }  

ll %>%
    make_interactive_map

```

## Remove brackets

```{r }  
ll %>%
    pipe_select_factors(5) %>%
    pipe_remove_brackets() %>%
    make_interactive_map

```

## Bundle factors

```{r }  
ll %>%
    pipe_bundle_factors(value = "IEA") %>%
    pipe_select_factors(5) %>%
    make_interactive_map



```

## Format links without bundling

```{r }  
ee %>%
  pipe_color_links("link_id",fun = "mean") %>%
  make_interactive_map
ee %>%
  pipe_scale_links("link_id",fun = "mean") %>%
  make_interactive_map

```


## Link labels

```{r }  
e3 %>%
  pipe_label_links("link_id",fun = "literal",add_field_name = T) %>%
  make_interactive_map

e3 %>%
  pipe_label_links("link_id",fun = "literal") %>%
  pipe_label_links("from_label",fun = "literal",add_field_name = T,clear_previous = F) %>%
  make_interactive_map

e3 %>%
  pipe_bundle_links() %>% 
  pipe_label_links("link_id",fun = "literal",add_field_name = T) %>%
  make_interactive_map

e3 %>%
  pipe_bundle_links() %>% 
  pipe_label_links("link_id",fun = "literal") %>%
  pipe_label_links("from_label",fun = "literal",clear_previous = F) %>%
  make_interactive_map


```


## Bundling links

Note the defaults for `bundle_links` and `label_links`:

```{r }  
ll %>%
    pipe_find_factors(value="economic") %>%
    pipe_select_factors(5) %>%
    pipe_bundle_links() %>%
    pipe_label_links() %>%
    make_interactive_map


```

```{r }  
ll %>%
    pipe_find_factors(value="economic") %>%
    pipe_select_factors(5) %>%
    pipe_bundle_links() %>%
    pipe_label_links() %>%
    make_interactive_map


```

Note the default for `bundle_links` is equivalent to simple_bundle:

```{r }  
ll %>%
    pipe_find_factors(value="economic") %>%
    pipe_select_factors(5) %>%
    pipe_bundle_links(group="simple_bundle") %>%
    pipe_label_links() %>%
    make_interactive_map


```

Group and label by sex and scale by count:

```{r }  
ll %>%
    pipe_select_factors(5) %>%
    pipe_bundle_links(group="1. Sex") %>%
    pipe_scale_links("link_id",fun = "count") %>%
    pipe_label_links("1. Sex",fun = "unique") %>%
    pipe_color_links("1. Sex",fun = "unique") %>%
    make_interactive_map
```

```{r }  
ll %>%
    pipe_select_links(16) %>%
    pipe_bundle_links(group="1. Sex") %>%
    pipe_label_links("link_id",fun = "count") %>%
    make_interactive_map
```


Group by sex and scale and colour by count:

```{r }  
ll %>%
    pipe_select_factors(5) %>%
    pipe_bundle_links(group="1. Sex") %>%
    pipe_color_links("link_id",fun = "count") %>%
    pipe_scale_links("link_id",fun = "count") %>%
    pipe_label_links("link_id",fun = "count") %>%
    make_interactive_map
```
Proportion

```{r}
ll %>%    
  pipe_find_factors(value="sed yield") %>%
  pipe_bundle_links(group="District") %>% 
  pipe_color_links(field="District",fun="unique") %>% 
  pipe_label_links(value="percent: link_id") %>%  
  pipe_scale_links(field="link_id",fun="count") %>%  
  make_print_map
```

```{r}
ll %>%    
  pipe_find_factors(value="sed yield") %>%
  pipe_bundle_links(group="1. Sex") %>% 
  pipe_color_links(field="1. Sex",fun="unique") %>% 
  pipe_label_links(field="link_id",fun="percent") %>%  
  pipe_scale_links(field="link_id",fun="count") %>%  
  make_print_map
```

```{r}
ll %>%    
  pipe_find_factors(value="sed yield") %>%
  pipe_bundle_links(group="1. Sex") %>% 
  pipe_color_links(field="1. Sex",fun="unique") %>% 
  pipe_label_links(field="source_id",fun="percent") %>%  
  pipe_scale_links(field="source_id",fun="percent") %>%  
  make_print_map

```

```{r}
ll %>%    
  pipe_find_factors(value="sed yield",down=0) %>%
  pipe_bundle_links(group="1. Sex") %>% 
  pipe_color_links(field="source_id",fun="percent") %>% 
  pipe_label_links(field="source_id",fun="percent") %>%  
  pipe_scale_links(field="source_id",fun="count") %>%  
  make_print_map

```

## Surprise

```{r}
ll %>%    
  pipe_find_factors(value="sed yield",down=0) %>%
  pipe_bundle_links(group="1. Sex") %>% 
  pipe_color_links(field="1. Sex",fun="unique") %>% 
  pipe_label_links(field="source_id",fun="surprise") %>%  
  pipe_scale_links(field="source_id",fun="count") %>%  
  make_print_map

```

```{r}
ll %>%    
  pipe_find_factors(value="sed yield",down=0) %>%
  pipe_bundle_links(group="1. Sex") %>% 
  pipe_label_links(field="1. Sex",fun="unique") %>% 
  pipe_color_links(field="source_id",fun="surprise") %>%  
  pipe_scale_links(field="source_id",fun="count") %>%  
  make_print_map

```


## Mark links

```{r}
so %>% 
  pipe_combine_opposites() %>% 
  pipe_bundle_links(group = "flipped_bundle") %>% 
  pipe_label_links(field = "source_id",fun="literal") %>% 
  make_print_map

so %>% 
  pipe_combine_opposites() %>% 
  pipe_bundle_links(group = "flipped_bundle") %>% 
  pipe_label_links(field = "source_id",fun="literal") %>% 
  pipe_mark_links(field="source_id") %>% 
  make_print_map



```



## Nested maps

```{r }  
tt %>%
    pipe_zoom_factors(1) %>%
    pipe_select_factors(5) %>%
    make_interactive_map

```


```{r }  
tt %>%
    pipe_zoom_factors(1) %>%
    pipe_bundle_links() %>%
    pipe_label_links() %>%
    pipe_scale_links() %>%
    make_print_map

```

## Zooming out and showing source count

```{r }  
oo %>%
    pipe_zoom_factors(1) %>%
    pipe_find_factors(value="Improved health and hygiene practices") %>%
  pipe_bundle_links(group="simple_bundle") %>% 
  pipe_label_links(field="source_id",fun = "count") %>% 
  pipe_wrap_factors() %>% 
    make_print_map 

```

## Combining opposites


```{r}
hh %>% 
  make_print_map()
hh %>% 
  pipe_combine_opposites %>% 
  make_print_map()

```



## Nested maps with opposites

Note colours in Interactive view

```{r }  
tt %>%
    pipe_zoom_factors(1) %>%
    pipe_combine_opposites() %>%
    pipe_select_links(3) %>%
    make_print_map
tt %>%
    pipe_zoom_factors(1) %>%
    pipe_combine_opposites() %>%
    pipe_select_links(3) %>%
    make_interactive_map

```


## Path tracing

```{r }  

cat("### Single\n")  

ee %>%    
  pipe_trace_paths(from = "Funds",to="area",length = 5) %>% 
  make_interactive_map

cat("### Case insensitive\n")  

ee %>%    
  pipe_trace_paths(from = "funds",to="aREa",length = 5) %>% 
  make_interactive_map

cat("### Failing; no paths at all\n")  

ee %>%    
  pipe_trace_paths(from = "xx",to="yy",length = 5) %>% 
  make_interactive_map

cat("### Failing; no paths\n")  
ee %>%    
  pipe_trace_paths(from = "Funds",to="yy",length = 5) %>% 
  make_interactive_map

ee %>%    
  pipe_trace_paths(from = "xx",to="Property",length = 5) %>% 
  make_interactive_map

cat("### Implicit multiple\n")  

ee %>%    
  pipe_trace_paths(from = "High",to="Damage",length = 5) %>% 
  make_interactive_map

cat("### Explicit multiple\n")  

ee %>%    
  pipe_trace_paths(from = "High",to="Property | Business",length = 5) %>% 
  make_interactive_map

ee %>%    
  pipe_trace_paths(from = "High",to="Property OR Business",length = 5) %>% 
  make_interactive_map

cat("Should this be possible?")

ee %>%    
  pipe_trace_paths(from = "High",to=c("Property","Business"),length = 5) %>% 
  make_interactive_map

tt %>%
  pipe_trace_paths(from = "Capabilities",to="[OP3]",length = 2) %>% 
  make_interactive_map

ee %>%    
  pipe_trace_paths(from = "Funds",to="area",length = 5) %>% 
  make_print_map()



```

### Robustness

```{r}  

ee %>%    
  pipe_trace_robustness(from = "High",to="Damage",length = 5) %>% 
  pipe_wrap_factors() %>% 
  make_print_map()

ee %>%    
  pipe_trace_robustness(from = "High",to="Damage",length = 5) %>% 
  get_robustness()

tt %>%
  pipe_trace_robustness(from = "Capabilities",to="[OP3]",length = 2) %>% 
  pipe_wrap_factors() %>% 
  make_print_map()

tt %>%
  pipe_trace_robustness(from = "Capabilities",to="[OP3",length = 2) %>% 
  pipe_wrap_factors() %>% 
  make_print_map()

tt %>%
  pipe_trace_robustness(from = "Capabilities",to="[OP3]",length = 2) %>% 
  get_robustness()

tt %>%
  pipe_trace_robustness(from = "Capabilities",to="[OP3",length = 2) %>% 
  get_robustness()

tt %>%
  pipe_trace_robustness(from = "Capabilities; [P13",to="[OP3]",length = 2) %>% 
  get_robustness()

```


```{r}
e3  %>%
  pipe_trace_robustness(from = "High",to="People moving",length = 5) %>% 
  make_print_map()
e3  %>%
  pipe_trace_robustness(from = "High",to="People moving",length = 5) %>% 
  get_robustness() %>% 
  kable
e3  %>%
  pipe_trace_robustness(from = "High",to="Flooding",length = 5) %>% 
  get_robustness() %>% 
  kable
e3  %>%
  pipe_trace_robustness(from = "High",to="Damage",length = 5) %>% 
  get_robustness() %>% 
  kable
e3  %>%
  pipe_trace_robustness(from = "External",to="Damage",length = 5) %>% 
  get_robustness() %>% 
  kable
e3  %>%
  pipe_trace_robustness(from = "External",to="Outcome",length = 5) %>% 
  get_robustness()%>% 
  kable


```


### Robustness by field

Just one source:

```{r}
ee  %>%
  pipe_trace_robustness(from = "Funds",to="Increased",length = 5,field = "source_id") %>% (get_robustness)

```



Check that opposites colouring is always preserved?

```{r}
hh  %>%
  pipe_trace_robustness(from = "Revision",to="happy",length = 5) %>% 
  pipe_combine_opposites %>% 
  make_print_map()

hh  %>%
  pipe_combine_opposites %>% 
  pipe_find_factors(value="exam") %>% 
  make_print_map()

hh  %>%
  pipe_combine_opposites %>% 
  pipe_zoom_factors() %>% 
  pipe_find_factors(value="exam") %>% 
  pipe_select_factors(2) %>% 
  pipe_select_links(3) %>% 
  make_print_map()


```


Colours in interactive map

```{r}
hh  %>%
  pipe_combine_opposites %>% 
  pipe_zoom_factors() %>% 
  make_interactive_map()


```


```{r }  
if(F){
graf <- tt1
graf$factors %>% filter(factor_id %notin% graf$links$from & factor_id %notin% graf$links$to)  %>% nrow

graf$links %>% filter(from %notin% graf$factors$factor_id & to %notin% graf$factors$factor_id)  %>% nrow

graf$links %>% filter(statement_id %notin% graf$statements$statement_id) %>% nrow
  }


```

## Cluster factors

```{r}
ee %>% 
  pipe_cluster_factors("Damage OR Flood") %>% 
  make_print_map
```

Pipe-able:

```{r}
ee %>% 
  pipe_cluster_factors("Damage OR Flood") %>% 
  pipe_cluster_factors("Rising") %>% 
  make_print_map
```





